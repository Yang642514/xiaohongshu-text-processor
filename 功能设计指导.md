

当前实现说明（v0.1.0）

一、文本处理与解析
- 分论点识别：支持中文序号（“论点一/二/三…”、“第1点”）、数字序号（“1.”、“1、”）、符号列举（“-”、“•”等）作为分论点起始标记；每个分论点拆分为“分论点标题”和“分论点内容”。
- 标点规范化：英文标点自动替换为中文标点（，。！？：；“”‘’等）。
- 排版规则：每段约 45 个中文字符自动折行（`max_chars_per_line=45`）；段落不限制行数（`max_lines_per_paragraph=0`），保持原有段落结构与顺序。

二、Excel 写入（保持模板样式不变）
- 表头定位：扫描模板前 10 行以寻找包含所需列的表头行。
- 必需列：`页面`、`文本_1`、`文本_2`、`页面比例`（若存在则自动写入）。
- 写入规则（每个分论点一行）：
  - `页面`：按序生成页面名，如“分论点一页面”、“分论点二页面”…；超过“二十”后使用数字序号。
  - `文本_1`：分论点标题。
  - `文本_2`：分论点内容（已按规则自动折行与中文标点规范）。
  - `页面比例`：若模板存在该列，自动写入全局默认比例 `3:4`（不再需要或显示“页面比例列名”的设置）。
- 输出文件名：`标题_时间戳.xlsx`；如无标题则使用 `输出_时间戳.xlsx`。

三、压缩打包
- 在设置的“压缩包目录”生成 ZIP；可选地删除生成的 Excel（`delete_excel_after_zip=true` 时仅保留 ZIP）。
- 压缩包命名：`标题_时间戳.zip`（与 Excel 同名）。

四、设置项（界面可配置）
- 模板路径：`template_excel_path`。
- 压缩包目录：`zip_output_dir`（所有输出均写入此目录）。
- 列映射：`page_column`、`point_title_column`、`point_content_column`（需与模板表头一致）。
- 全局页面比例：`page_ratio`（默认 `3:4`，用于写入 `页面比例` 列的值；不再支持“页面比例列名”设置）。
- 文本排版：`max_chars_per_line=45`、`max_lines_per_paragraph=0`。

五、错误处理与日志
- 模板校验：前 10 行找不到必需列会报错并弹窗提示；日志记录具体缺失列与表头行信息。
- 运行日志：位于 `logs/run_*.log`，包含启动、解析、写入、打包、错误等详细记录。

六、使用流程（简要）
- 在主界面粘贴文案 → 点击“开始处理”生成可编辑的处理模板文本 → 点击“写入并打包” → 在压缩包目录查看生成的 ZIP（必要时打开 Excel 验证行内容）。

七、验证要点
- 模板首行包含 `页面/文本_1/文本_2`（可选：`页面比例`）。
- 生成的 Excel 中，每个分论点占一行，`页面` 为“分论点×页面”，`文本_1` 为标题，`文本_2` 为内容；若存在 `页面比例` 列则为 `3:4`。
- ZIP 命名包含标题和时间戳，且在设置的目录中生成；如启用删除 Excel，仅保留 ZIP。
- 日志记录了程序的运行过程，包括启动、解析、写入、打包、错误等。

八、配图功能（新增，可选）
- 目标：为每个分论点自动或手动配图，统一尺寸，写入模板并输出“配图版”压缩包。
- 关键词策略：优先取分论点标题；不足时从分论点内容补充；支持手动编辑每行关键词。
- 图片来源：支持免费无版权站（Pixabay/Pexels）或 AI 绘画；可单点刷新某论点图片。
- 抠图支持：默认使用本地开源 `rembg`；可关闭或选择云 API（如 remove.bg）。
- 自动裁剪与统一大小：对选定图片进行裁剪或填充，得到统一尺寸（如 1024×1024）；模式可选“覆盖裁剪（cover）”或“等比填充（contain）”。

九、配图页面（GUI）设计
- 顶部区块（配置与状态）：
  - 图片来源选择：`Pixabay | Pexels | AI`
  - API Key 输入（按来源显示）
  - 是否抠图开关、抠图方式：`rembg | api`
  - 自动裁剪开关；裁剪尺寸输入（如 `1024x1024`）
  - 裁剪模式选择：`cover（居中裁剪，充满） | contain（等比缩放，留边填充）`
  - 填充背景色（contain 模式可选，默认白色）
  - 缩略图尺寸（预览用，如 `160x120`）
  - 输出格式：`png | jpg`（默认 `png`）
- 主表格（每行一个分论点）：
  - 论点标题（只读）
  - 关键词（可编辑）
  - 图片预览（缩略图，点击查看原图）
  - 操作：`刷新此论点`、`替换本地图片`、`打开原图`
  - 状态：`已选 | 已抠图 | 已裁剪 | 失败（错误信息）`
- 底部操作：
  - `批量自动配图`（当前配置应用到全部行）
  - `全部抠图`、`全部裁剪`
  - `写入模板并压缩`（输出“配图版”）
  - `返回`（回到主页）

十、关键词与检索（实现建议）
- 生成：`jieba` 分词，取名词/形容词 Top-K（如 2–3 个），过滤停用词与低质词；可手动覆盖。
- 检索与下载：按关键词查询来源 API，优先返回竖图或方图；下载到本地缓存。
- 选择：每行允许多图候选，用户可确定最终使用的一张。

十一、自动裁剪与统一大小（实现建议）
- 输入：原图路径；输出：统一尺寸文件（如 `1024x1024`）。
- `cover` 模式：等比缩放至保证短边 ≥ 目标尺寸，然后居中裁剪到目标宽高。
- `contain` 模式：等比缩放至长边 ≤ 目标尺寸，然后居中放置在目标画布，空白区用背景色填充。
- 工具：`Pillow`（PIL）或 `OpenCV`；默认使用 `Pillow` 实现。
- 质量：可选重采样（如 `LANCZOS`）；可配置 JPEG 质量（如 90）。
- 失败回退：裁剪失败则保留原图并提示。

十二、文件命名与目录组织
- 文案输出目录（配图版）：`output/<主题>-配图版/`
- 单图命名：`论点{序号}配图-{关键词}.png`（中文关键词保留，移除特殊符号与空格）
- 抠图后可覆盖原图或生成后缀版本：如 `论点{序号}配图-{关键词}-抠图.png`
- Excel 与图片同目录，便于打包。
- 非配图版保持现有结构与命名：`output/<主题>.zip`

十三、模板写入（图片列）
- 在模板每行写入图片列 `图片_1`（与现有表头一致）。
- 写入内容：图片文件名（建议仅文件名，所在目录隐含路径）。
- 其它文本列（`页面/文本_1/文本_2` 等）按现有规则写入；新增列兼容处理。

十四、打包与命名规则
- 不配图：`<主题>.zip`（保持现状）
- 配图版：`<主题>-配图版.zip`（包含 Excel 与图片文件）
- 可选：配图版 zip 内保留一个 `images/` 目录（与 Excel 同层或子目录，具体以模板工具兼容为准）

十五、配置项（配图页专属，持久化到设置）
- `enable_image_feature`（bool）：是否启用配图功能
- `image_source`：`pixabay | pexels | ai`
- `image_api_key`：来源 API Key
- `image_keyword_strategy`：`title_first`（默认）
- `remove_bg_enabled`（bool）：是否抠图
- `remove_bg_method`：`rembg | api`
- `auto_crop_enabled`（bool）：是否自动裁剪
- `crop_size`：如 `1024x1024`
- `crop_mode`：`cover | contain`
- `contain_bg_color`：hex 色值（如 `#FFFFFF`）
- `image_format`：`png | jpg`（默认 `png`）
- `thumbnail_size`：如 `160x120`
- `image_per_point`：每论点图片数（默认 1）
- `zip_suffix_for_images`：默认 `配图版`
- 配置入口：仅在“配图页面”展示与编辑；保存后持久化到 `settings.json`。

十六、并发与缓存
- 并发执行下载/抠图/裁剪（线程池或 `QThreadPool`）；每行显示进度和状态。
- 速率限制与重试：避免请求被封，指数回退策略。
- 本地缓存：按 `来源+关键词` 保存下载结果；失败记录用于后续避让。

十七、错误处理与日志
- 检索失败：显示占位图与错误信息；可编辑关键词重试。
- 抠图失败：自动回退至原图；状态提示。
- 裁剪失败：保留原图并提示；允许手动替换。
- 关键配置缺失（如 API Key）：引导在配图页填写；允许本地替换图片。
- 日志：记录检索、下载、抠图、裁剪、写入、打包的流水，与错误堆栈。
- 用户确认：在写入前支持全局预览与局部放大查看。

十八、使用流程（配图版）
- 主页：点击“文案处理” → “配图”（进入配图页）
- 配图页：自动生成关键词与图片 → 用户可预览、改关键词、单个刷新、替换本地文件 → 可选抠图与裁剪统一尺寸
- 确认无误后：点击“写入模板并压缩” → 输出 `<主题>-配图版.zip`
- 不配图版：跳过配图页，直接“写入模板并压缩”，输出标准 zip